#!/bin/bash

# Universal Unpacker Tool
# Automatically detects and extracts various archive formats

set -e

VERSION="1.0.0"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored messages
print_success() { echo -e "${GREEN}[✓]${NC} $1"; }
print_error() { echo -e "${RED}[✗]${NC} $1"; }
print_info() { echo -e "${BLUE}[i]${NC} $1"; }
print_warning() { echo -e "${YELLOW}[!]${NC} $1"; }

# Function to show usage
show_usage() {
    cat << EOF
Universal Unpacker v${VERSION}

Usage: unpack [OPTIONS] <archive_file> [destination]

Options:
    -h, --help          Show this help message
    -v, --verbose       Show detailed extraction output
    -k, --keep          Keep archive after extraction
    -f, --force         Overwrite existing files
    --version           Show version information

Supported formats:
    - tar, tar.gz, tgz, tar.bz2, tbz2, tar.xz, txz, tar.zst
    - zip, jar, war, ear
    - rar
    - 7z
    - gz, bz2, xz, zst (single file compression)
    - deb, rpm
    - iso, img

Examples:
    unpack archive.tar.gz
    unpack archive.zip /tmp/extracted
    unpack -v archive.7z
    unpack --keep file.tar.xz ./output

EOF
}

# Check if required tools are installed
check_dependencies() {
    local missing_deps=()
    
    # Check for common tools
    command -v tar >/dev/null 2>&1 || missing_deps+=("tar")
    command -v file >/dev/null 2>&1 || missing_deps+=("file")
    
    if [ ${#missing_deps[@]} -gt 0 ]; then
        print_error "Missing required dependencies: ${missing_deps[*]}"
        print_info "Install with: sudo apt install ${missing_deps[*]}"
        exit 1
    fi
}

# Detect archive type
detect_type() {
    local archive="$1"
    local mime_type=$(file -b --mime-type "$archive")
    local file_output=$(file -b "$archive")
    
    # Check by MIME type first
    case "$mime_type" in
        application/x-tar)
            echo "tar"
            ;;
        application/gzip|application/x-gzip)
            if [[ "$archive" =~ \.(tar\.gz|tgz)$ ]]; then
                echo "tar.gz"
            else
                echo "gz"
            fi
            ;;
        application/x-bzip2)
            if [[ "$archive" =~ \.(tar\.bz2|tbz2?)$ ]]; then
                echo "tar.bz2"
            else
                echo "bz2"
            fi
            ;;
        application/x-xz)
            if [[ "$archive" =~ \.(tar\.xz|txz)$ ]]; then
                echo "tar.xz"
            else
                echo "xz"
            fi
            ;;
        application/zstd|application/x-zstd)
            if [[ "$archive" =~ \.tar\.zst$ ]]; then
                echo "tar.zst"
            else
                echo "zst"
            fi
            ;;
        application/zip|application/java-archive)
            echo "zip"
            ;;
        application/x-rar|application/vnd.rar)
            echo "rar"
            ;;
        application/x-7z-compressed)
            echo "7z"
            ;;
        application/x-debian-package)
            echo "deb"
            ;;
        application/x-rpm)
            echo "rpm"
            ;;
        application/x-iso9660-image)
            echo "iso"
            ;;
        *)
            # Fallback to extension-based detection
            case "${archive,,}" in
                *.tar) echo "tar" ;;
                *.tar.gz|*.tgz) echo "tar.gz" ;;
                *.tar.bz2|*.tbz|*.tbz2) echo "tar.bz2" ;;
                *.tar.xz|*.txz) echo "tar.xz" ;;
                *.tar.zst) echo "tar.zst" ;;
                *.zip|*.jar|*.war|*.ear) echo "zip" ;;
                *.rar) echo "rar" ;;
                *.7z) echo "7z" ;;
                *.gz) echo "gz" ;;
                *.bz2) echo "bz2" ;;
                *.xz) echo "xz" ;;
                *.zst) echo "zst" ;;
                *.deb) echo "deb" ;;
                *.rpm) echo "rpm" ;;
                *.iso|*.img) echo "iso" ;;
                *)
                    echo "unknown"
                    ;;
            esac
            ;;
    esac
}

# Extract archive
extract_archive() {
    local archive="$1"
    local dest="$2"
    local archive_type="$3"
    local verbose_flag=""
    
    if [ "$VERBOSE" = true ]; then
        verbose_flag="v"
    fi
    
    # Create destination directory if it doesn't exist
    if [ -n "$dest" ]; then
        mkdir -p "$dest"
    fi
    
    case "$archive_type" in
        tar)
            tar -x${verbose_flag}f "$archive" ${dest:+-C "$dest"}
            ;;
        tar.gz)
            tar -x${verbose_flag}zf "$archive" ${dest:+-C "$dest"}
            ;;
        tar.bz2)
            tar -x${verbose_flag}jf "$archive" ${dest:+-C "$dest"}
            ;;
        tar.xz)
            tar -x${verbose_flag}Jf "$archive" ${dest:+-C "$dest"}
            ;;
        tar.zst)
            if command -v zstd >/dev/null 2>&1; then
                tar -x${verbose_flag} --zstd -f "$archive" ${dest:+-C "$dest"}
            else
                print_error "zstd not installed. Install with: sudo apt install zstd"
                return 1
            fi
            ;;
        zip)
            if [ "$VERBOSE" = true ]; then
                unzip ${FORCE:+-o} "$archive" ${dest:+-d "$dest"}
            else
                unzip -q ${FORCE:+-o} "$archive" ${dest:+-d "$dest"}
            fi
            ;;
        rar)
            if command -v unrar >/dev/null 2>&1; then
                unrar x ${FORCE:+-o+} ${VERBOSE:+-v} "$archive" ${dest:+"$dest/"}
            else
                print_error "unrar not installed. Install with: sudo apt install unrar"
                return 1
            fi
            ;;
        7z)
            if command -v 7z >/dev/null 2>&1; then
                7z x ${FORCE:+-y} "$archive" ${dest:+-o"$dest"}
            else
                print_error "7z not installed. Install with: sudo apt install p7zip-full"
                return 1
            fi
            ;;
        gz)
            local outfile="${archive%.gz}"
            [ -n "$dest" ] && outfile="$dest/$(basename "$outfile")"
            gunzip ${FORCE:+-f} ${VERBOSE:+-v} -c "$archive" > "$outfile"
            ;;
        bz2)
            local outfile="${archive%.bz2}"
            [ -n "$dest" ] && outfile="$dest/$(basename "$outfile")"
            bunzip2 ${FORCE:+-f} ${VERBOSE:+-v} -c "$archive" > "$outfile"
            ;;
        xz)
            local outfile="${archive%.xz}"
            [ -n "$dest" ] && outfile="$dest/$(basename "$outfile")"
            unxz ${FORCE:+-f} ${VERBOSE:+-v} -c "$archive" > "$outfile"
            ;;
        zst)
            if command -v zstd >/dev/null 2>&1; then
                local outfile="${archive%.zst}"
                [ -n "$dest" ] && outfile="$dest/$(basename "$outfile")"
                zstd -d ${FORCE:+-f} ${VERBOSE:+-v} "$archive" -o "$outfile"
            else
                print_error "zstd not installed. Install with: sudo apt install zstd"
                return 1
            fi
            ;;
        deb)
            if command -v dpkg-deb >/dev/null 2>&1; then
                local extract_dir="${dest:-.}/$(basename "$archive" .deb)"
                mkdir -p "$extract_dir"
                dpkg-deb -x "$archive" "$extract_dir"
                print_info "Extracted to: $extract_dir"
            else
                print_error "dpkg-deb not available"
                return 1
            fi
            ;;
        rpm)
            if command -v rpm2cpio >/dev/null 2>&1 && command -v cpio >/dev/null 2>&1; then
                local extract_dir="${dest:-.}/$(basename "$archive" .rpm)"
                mkdir -p "$extract_dir"
                cd "$extract_dir"
                rpm2cpio "../$archive" | cpio -idm${VERBOSE:+v}
                cd - >/dev/null
                print_info "Extracted to: $extract_dir"
            else
                print_error "rpm2cpio or cpio not installed. Install with: sudo apt install rpm2cpio cpio"
                return 1
            fi
            ;;
        iso)
            if command -v 7z >/dev/null 2>&1; then
                local extract_dir="${dest:-.}/$(basename "$archive" .iso)"
                mkdir -p "$extract_dir"
                7z x ${FORCE:+-y} "$archive" -o"$extract_dir"
                print_info "Extracted to: $extract_dir"
            else
                print_error "7z not installed. Install with: sudo apt install p7zip-full"
                return 1
            fi
            ;;
        *)
            print_error "Unsupported or unknown archive format"
            return 1
            ;;
    esac
}

# Main function
main() {
    local archive=""
    local dest=""
    VERBOSE=false
    KEEP=false
    FORCE=false
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                show_usage
                exit 0
                ;;
            --version)
                echo "Universal Unpacker v${VERSION}"
                exit 0
                ;;
            -v|--verbose)
                VERBOSE=true
                shift
                ;;
            -k|--keep)
                KEEP=true
                shift
                ;;
            -f|--force)
                FORCE=true
                shift
                ;;
            -*)
                print_error "Unknown option: $1"
                echo "Use --help for usage information"
                exit 1
                ;;
            *)
                if [ -z "$archive" ]; then
                    archive="$1"
                elif [ -z "$dest" ]; then
                    dest="$1"
                else
                    print_error "Too many arguments"
                    exit 1
                fi
                shift
                ;;
        esac
    done
    
    # Check if archive file was provided
    if [ -z "$archive" ]; then
        print_error "No archive file specified"
        echo "Use --help for usage information"
        exit 1
    fi
    
    # Check if archive exists
    if [ ! -f "$archive" ]; then
        print_error "File not found: $archive"
        exit 1
    fi
    
    # Check dependencies
    check_dependencies
    
    # Detect archive type
    print_info "Detecting archive type..."
    archive_type=$(detect_type "$archive")
    
    if [ "$archive_type" = "unknown" ]; then
        print_error "Unable to detect archive type for: $archive"
        exit 1
    fi
    
    print_success "Detected format: $archive_type"
    
    # Extract archive
    print_info "Extracting $(basename "$archive")..."
    
    if extract_archive "$archive" "$dest" "$archive_type"; then
        print_success "Extraction complete!"
        
        # Remove archive if not keeping
        if [ "$KEEP" = false ]; then
            rm -f "$archive"
            print_info "Removed archive file"
        fi
    else
        print_error "Extraction failed"
        exit 1
    fi
}

# Run main function
main "$@"
